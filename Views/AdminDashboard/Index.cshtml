@model dynamic
@{
    ViewData["Title"] = "Admin Dashboard";
}
<link rel="stylesheet" href="~/css/dashboard/admin-dashboard.css" asp-append-version="true" />
<style>
    @@keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @@keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
</style>

<div class="dashboard-wrapper">
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="dashboard-title">Admin Dashboard</h1>
                <p class="dashboard-subtitle">Golden Leaf Restaurant Management</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <a href="@Url.Action("Notifications")" style="position: relative; text-decoration: none;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    @if ((int)Model.UnreadNotifications > 0)
                    {
                        <span data-notification-badge style="position: absolute; top: -8px; right: -8px; background: #ff4757; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">@Model.UnreadNotifications</span>
                    }
                    else
                    {
                        <span data-notification-badge style="position: absolute; top: -8px; right: -8px; background: #ff4757; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">0</span>
                    }
                </a>
                <a href="@Url.Action("Logout", "AdminAccount")" class="btn-logout">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M13 3H16C16.5304 3 17.0391 3.21071 17.4142 3.58579C17.7893 3.96086 18 4.46957 18 5V15C18 15.5304 17.7893 16.0391 17.4142 16.4142C17.0391 16.7893 16.5304 17 16 17H13M7 13L3 10M3 10L7 7M3 10H13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card stat-bookings">
                <div class="stat-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path d="M26 4H6C4.89543 4 4 4.89543 4 6V26C4 27.1046 4.89543 28 6 28H26C27.1046 28 28 27.1046 28 26V6C28 4.89543 27.1046 4 26 4Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M10 2V6M22 2V6M4 10H28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 class="stat-label">Total Bookings</h3>
                    <p class="stat-value">@Model.TotalBookings</p>
                    <span class="stat-trend">Active reservations</span>
                </div>
            </div>

            <div class="stat-card stat-menu">
                <div class="stat-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path d="M4 8H28M4 16H28M4 24H28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
                        <circle cx="8" cy="16" r="1.5" fill="currentColor"/>
                        <circle cx="8" cy="24" r="1.5" fill="currentColor"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 class="stat-label">Menu Items</h3>
                    <p class="stat-value">@Model.TotalMenuItems</p>
                    <span class="stat-trend">Available dishes</span>
                </div>
            </div>

            <div class="stat-card stat-categories">
                <div class="stat-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <rect x="4" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                        <rect x="18" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                        <rect x="4" y="18" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                        <rect x="18" y="18" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 class="stat-label">Categories</h3>
                    <p class="stat-value">@Model.TotalCategories</p>
                    <span class="stat-trend">Menu sections</span>
                </div>
            </div>

            <div class="stat-card stat-admins">
                <div class="stat-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path d="M24 28V25.3333C24 23.9188 23.4732 22.5623 22.5355 21.5621C21.5979 20.5619 20.3261 20 19 20H13C11.6739 20 10.4021 20.5619 9.46447 21.5621C8.52678 22.5623 8 23.9188 8 25.3333V28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="16" cy="10" r="6" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 class="stat-label">Admins</h3>
                    <p class="stat-value">@Model.TotalAdmins</p>
                    <span class="stat-trend">Team members</span>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Management Section -->
            <div class="management-section">
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Management</h2>
                        <p class="section-description">Manage restaurant data and settings</p>
                    </div>
                    <div class="management-grid">
                        <a href="@Url.Action("Categories", "AdminDashboard")" class="management-card">
                            <div class="management-icon" style="background: linear-gradient(135deg, #C9A961, #D4AF37);">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect x="3" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                                    <rect x="14" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                                    <rect x="3" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                                    <rect x="14" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </div>
                            <div class="management-content">
                                <h3 class="management-title">Categories</h3>
                                <p class="management-description">Organize menu sections</p>
                            </div>
                            <svg class="management-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M7 4L13 10L7 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </a>

                        <a href="@Url.Action("MenuItems", "AdminDashboard")" class="management-card">
                            <div class="management-icon" style="background: linear-gradient(135deg, #8B9D83, #A4B89A);">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M3 6H21M3 12H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="management-content">
                                <h3 class="management-title">Menu Items</h3>
                                <p class="management-description">Edit dishes and pricing</p>
                            </div>
                            <svg class="management-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M7 4L13 10L7 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </a>

                        <a href="@Url.Action("Tables", "AdminDashboard")" class="management-card">
                            <div class="management-icon" style="background: linear-gradient(135deg, #D4A574, #E8C4A0);">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect x="3" y="3" width="8" height="8" stroke="currentColor" stroke-width="2"/>
                                    <rect x="13" y="3" width="8" height="8" stroke="currentColor" stroke-width="2"/>
                                    <rect x="3" y="13" width="8" height="8" stroke="currentColor" stroke-width="2"/>
                                    <rect x="13" y="13" width="8" height="8" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </div>
                            <div class="management-content">
                                <h3 class="management-title">Tables</h3>
                                <p class="management-description">Manage availability status</p>
                            </div>
                            <svg class="management-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M7 4L13 10L7 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </a>

                        <a href="@Url.Action("Admins", "AdminDashboard")" class="management-card">
                            <div class="management-icon" style="background: linear-gradient(135deg, #1A3C34, #234D43);">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2"/>
                                    <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                                    <path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13M16 3.13C16.8604 3.3503 17.623 3.8507 18.1676 4.55231C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89317 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="management-content">
                                <h3 class="management-title">Admins</h3>
                                <p class="management-description">Manage team access</p>
                            </div>
                            <svg class="management-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M7 4L13 10L7 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </a>

                        <a href="@Url.Action("Index", "AdminBookings")" class="management-card">
                            <div class="management-icon" style="background: linear-gradient(135deg, #4A90A4, #5FA8C0);">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                    <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <circle cx="8" cy="15" r="1.5" fill="currentColor"/>
                                    <circle cx="12" cy="15" r="1.5" fill="currentColor"/>
                                    <circle cx="16" cy="15" r="1.5" fill="currentColor"/>
                                </svg>
                            </div>
                            <div class="management-content">
                                <h3 class="management-title">Bookings</h3>
                                <p class="management-description">View reservations</p>
                            </div>
                            <svg class="management-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M7 4L13 10L7 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recent Notifications Section -->
            @if (Model.Notifications != null && Model.Notifications.Count > 0)
            {
                <div class="notifications-section">
                    <div class="section-card">
                        <div class="section-header">
                            <h2 class="section-title">ðŸ”” Recent Notifications</h2>
                            <a href="@Url.Action("Notifications")" class="view-all-link">View All</a>
                        </div>
                        <div class="notifications-content">
                            @foreach (var notification in Model.Notifications)
                            {
                                <div class="notification-item-dashboard @(notification.IsRead ? "read" : "unread")">
                                    <div class="notification-dot"></div>
                                    <div class="notification-text">
                                        <p>@notification.Message</p>
                                        <span class="notification-time">@notification.CreatedAt.ToString("g")</span>
                                    </div>
                                    @if (notification.BookingId != null && notification.BookingId > 0)
                                    {
                                        <a href="@Url.Action("Index", "AdminBookings")" class="notification-action">View â†’</a>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Quick Info Section -->
            <div class="info-section">
                <div class="section-card info-card">
                    <div class="info-header">
                        <div class="info-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 16V12M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <h2 class="section-title">Quick Info</h2>
                    </div>
                    <div class="info-content">
                        <p class="info-text">Welcome to the Golden Leaf admin panel. Use the management cards to navigate through different sections and manage your restaurant efficiently.</p>
                        
                        <div class="info-features">
                            <div class="info-feature">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path d="M7 10L9 12L13 8M19 10C19 14.9706 14.9706 19 10 19C5.02944 19 1 14.9706 1 10C1 5.02944 5.02944 1 10 1C14.9706 1 19 5.02944 19 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <span>Real-time updates</span>
                            </div>
                            <div class="info-feature">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path d="M10 1V3M10 17V19M3.93 3.93L5.34 5.34M14.66 14.66L16.07 16.07M1 10H3M17 10H19M3.93 16.07L5.34 14.66M14.66 5.34L16.07 3.93" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <span>Easy management</span>
                            </div>
                            <div class="info-feature">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path d="M10 1L12.5 6.5L19 7.5L14.5 11.5L16 18L10 15L4 18L5.5 11.5L1 7.5L7.5 6.5L10 1Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                </svg>
                                <span>Premium control</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card status-card">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span class="status-text">System Online</span>
                    </div>
                    <p class="status-description">All services are running smoothly</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signalr@latest/signalr.min.js"></script>
<script>
    // Initialize SignalR connection
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/notificationHub")
        .withAutomaticReconnect()
        .build();

    connection.on("ReceiveBookingNotification", function (notification) {
        console.log("Real-time notification received:", notification);
        
        // Show notification toast
        showNotificationToast(notification);
        
        // Update the notification badge immediately
        updateBadgeImmediate();
        
        // Add notification to the list if visible
        addNotificationToList(notification);
    });

    connection.start().catch(function (err) {
        return console.error(err);
    });

    function showNotificationToast(notification) {
        // Create toast element
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        `;
        
        const itemsList = notification.items && notification.items.length > 0 
            ? notification.items.join(", ")
            : "Items";
        
        toast.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 8px;">ðŸ”” New Booking Alert</div>
            <div>${notification.customerName} - Table (TBA)</div>
            <div style="font-size: 12px; margin-top: 4px; opacity: 0.9;">${itemsList}</div>
        `;
        
        document.body.appendChild(toast);
        
        // Remove after 6 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 6000);
    }

    function updateBadgeImmediate() {
        const badge = document.querySelector('[data-notification-badge]');
        if (badge) {
            // Get current count
            let currentCount = parseInt(badge.textContent) || 0;
            currentCount++;
            
            // Update badge
            badge.textContent = currentCount;
            badge.style.display = 'flex';
        } else {
            // Create badge if it doesn't exist
            const bellLink = document.querySelector('a[href*="Notifications"]');
            if (bellLink) {
                const newBadge = document.createElement('span');
                newBadge.setAttribute('data-notification-badge', '');
                newBadge.style.cssText = 'position: absolute; top: -8px; right: -8px; background: #ff4757; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;';
                newBadge.textContent = '1';
                bellLink.style.position = 'relative';
                bellLink.appendChild(newBadge);
            }
        }
    }

    function addNotificationToList(notification) {
        // Find the notifications content container
        let notificationsContent = document.querySelector('.notifications-content');

        // If notifications section isn't present, create it and insert into the dashboard
        if (!notificationsContent) {
            const contentGrid = document.querySelector('.content-grid');
            if (contentGrid) {
                const notificationsSectionHTML = `
                    <div class="notifications-section">
                        <div class="section-card">
                            <div class="section-header">
                                <h2 class="section-title">ðŸ”” Recent Notifications</h2>
                                <a href="/AdminDashboard/Notifications" class="view-all-link">View All</a>
                            </div>
                            <div class="notifications-content"></div>
                        </div>
                    </div>
                `;

                // Insert notifications section at the top of the content grid
                contentGrid.insertAdjacentHTML('afterbegin', notificationsSectionHTML);
                notificationsContent = document.querySelector('.notifications-content');
            }
        }

        if (!notificationsContent) return; // nothing we can do

        // Create new notification item
        const newNotificationHTML = `
            <div class="notification-item-dashboard unread">
                <div class="notification-dot"></div>
                <div class="notification-text">
                    <p>${notification.message || notification.Message}</p>
                    <span class="notification-time">${new Date().toLocaleString()}</span>
                </div>
                ${notification.bookingId || notification.BookingId ? `<a href="/AdminBookings/Index" class="notification-action">View â†’</a>` : ''}
            </div>
        `;

        // Insert at the beginning
        notificationsContent.insertAdjacentHTML('afterbegin', newNotificationHTML);

        // Keep only 10 notifications visible
        const items = notificationsContent.querySelectorAll('.notification-item-dashboard');
        if (items.length > 10) {
            items[items.length - 1].remove();
        }
    }

    function updateNotificationBadge() {
        // Fetch unread notification count via AJAX
        fetch('/AdminDashboard/GetUnreadNotificationCount')
            .then(response => response.json())
            .then(data => {
                const badge = document.querySelector('[data-notification-badge]');
                if (badge) {
                    if (data.unreadCount > 0) {
                        badge.textContent = data.unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            })
            .catch(error => console.error('Error fetching notification count:', error));
    }
</script>
